
<!DOCTYPE html>
<html>
  <head>
    <%- include('./includes/head', { siteTitle: `${page.title} | ${config.title}` }) %>
  </head>
  <body>
    <div id="app" class="main">
      <%- include('./includes/header') %>

      <div class="content-container">
        <div class="post-detail">
          <% if (page.img && page.img != '') { %>
            <div class="feature-container" style="background-image: url('<%= page.img %>')">
            </div>
          <% } %>
          <h2 class="post-title"><%= page.title %></h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> <%= date(page.date, config.date_format) %></span>
            <% if (page.tags && page.tags.length > 0) { %>
              <span>
              <i class="icon-pricetags-outline"></i>
                <% page.tags.forEach(function(tag, index) { %>
                  <a href="<%= url_for(tag.path) %>">
                  <%= tag.name %>
                    <% if (index !== page.tags.length - 1) { %>
                      ，
                    <% } %>
                  </a>
                <% }); %>
              </span>
            <% } %>
          </div>
          <div class="post-content-wrapper">
            <div class="post-content">
              <%- page.content %>
            </div>
            <div class="top-div">
              <%- toc(page.content, {class: 'top-box',list_number:false,max_depth:3}) %>
            </div>
          </div>
        </div>

        <% if (page.next) { %>
          <div class="next-post">
            <a class="purple-link" href="<%- url_for(page.next.path) %>">
              <h3 class="post-title">
                下一篇：<%= page.next.title %>
              </h3>
            </a>
          </div>
        <% } %>
      </div>

    <% if (theme.gitalk.enable) { %>
      <div id="gitalk-container"></div>
    <% } %>


      <%- include('./includes/footer') %>

    </div>
    <%- include('./includes/scripts') %>

    <% if (theme.gitalk.enable) { %>

        <% if (theme.use_bootcdn) { %>
            <script src="https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.2/gitalk.min.js"></script>
        <% } else { %>
            <script src="<%= url_for('/js/gitalk.min.js') %>"></script>
        <% } %>

        <script>

          var gitalk = new Gitalk({
            clientID: '<%= theme.gitalk.clientId %>',
            clientSecret: '<%= theme.gitalk.clientSecret %>',
            repo: '<%= theme.gitalk.repository %>',
            owner: '<%= theme.gitalk.owner %>',
            admin: ['<%= theme.gitalk.owner %>'],
            id: location.pathname.slice(1, location.pathname.lastIndexOf('/')).substring(0, 49),       // Ensure uniqueness and length less than 50
            distractionFreeMode: false  // Facebook-like distraction free mode
          })

          gitalk.render('gitalk-container')

        </script>
    <% } %>

    <script>
        // 代码语言
        $(function () {
          $('code').each(function () {
            var code_language = $(this).attr('class');

            if (!code_language) {
              return true;
            }
            var lang_name = code_language.replace("line-numbers", "").trim().replace("highlight", "").trim().replace("language-", "").trim();

            $(this).attr('data-content-after', lang_name || 'CODE');
          });
          $('.highlight').each(function () {
            var code_language = $(this).attr('class');

            if (!code_language) {
              return true;
            }
            var lang_name = code_language.replace("highlight", "").trim();

            $(this).attr('data-content-after', lang_name || 'CODE');
          });
        });

        let mainNavLinks = document.querySelectorAll(".top-box a");

        window.addEventListener("scroll", event => {
          let fromTop = window.scrollY + 100;

          mainNavLinks.forEach((link, index) => {
            let section = document.getElementById(decodeURI(link.hash).substring(1));
            let nextSection = null
            if (mainNavLinks[index + 1]) {
              nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
            }
            if (section.offsetTop <= fromTop) {
              if (nextSection) {
                if (nextSection.offsetTop > fromTop) {
                  link.classList.add("current");
                } else {
                  link.classList.remove("current");
                }
              } else {
                link.classList.add("current");
              }
            } else {
              link.classList.remove("current");
            }
          });
        });
    </script>
  </body>
</html>
